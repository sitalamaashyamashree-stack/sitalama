<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Competition Registration</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
body{font-family: Arial, sans-serif;background:#eef1f5;margin:0;padding:0;}
.container{
    width:95%;max-width:600px;margin:40px auto;background:white;
    padding:30px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);
}
h2{text-align:center;font-size:26px;margin-bottom:20px;}
label{display:block;margin:10px 0 5px;font-weight:600;}
input, select{
    width:100%;padding:12px;border:1px solid #ccc;border-radius:8px;
    background:#f8f9fb;font-size:16px;
}
.category-list{
    border:1px solid #ddd;border-radius:10px;background:#fafafa;
    padding:10px 15px;margin-top:8px;
}
.cat-row{
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 0;border-bottom:1px solid #eee;font-size:15px;
}
.cat-row:last-child{border-bottom:none;}
.cat-row input[type=radio]{width:22px;height:22px;cursor:pointer;}
button{
    width:100%;padding:15px;background:#0D6EFD;color:white;border:none;
    border-radius:10px;font-size:18px;font-weight:bold;cursor:pointer;margin-top:20px;
}
button:hover{background:#094eb3;}
.terms-row{display:flex;align-items:center;gap:10px;margin-top:15px;font-size:15px;}
.terms-row input{width:20px;height:20px;}
.terms-row a{color:#0d6efd;font-weight:600;text-decoration:none;}
.error-msg{color:red;font-size:14px;margin-top:4px;font-weight:600;}
input.invalid{border:2px solid red !important;}
.notice{text-align:center;font-size:14px;margin-top:15px;line-height:1.5;color:#444;}

@media(max-width:480px){
 .container{padding:20px;}h2{font-size:22px;}
 input,select,button{font-size:16px;} .cat-row{font-size:14px;}
}
</style>
</head>

<body>

<div class="container">
<h2>Competition Registration</h2>

<label>Name *</label>
<input type="text" id="name">

<label>Guardian Name *</label>
<input type="text" id="guardian">

<label>Relation With Guardian *</label>
<select id="relation">
<option value="">-- Select Relation --</option>
<option value="Father">Father</option>
<option value="Mother">Mother</option>
<option value="Other">Other</option>
</select>

<label>Mobile No. (OTP Verify) *</label>
<input type="text" id="mobile">
<button onclick="sendOTP()">Send OTP</button>
<input type="text" id="otp" placeholder="Enter OTP">

<label>Email *</label>
<input type="email" id="email">

<label>Date of Birth *</label>
<input type="date" id="dob" oninput="liveDOBCheck()">
<div id="dobError" class="error-msg"></div>

<label>School / College / Institution (Optional)</label>
<input type="text" id="institution" placeholder="Optional">

<label>Category *</label>
<div class="category-list" id="categorySection">
<div class="cat-row"><span>Art & Craft (11-25 yrs) - ‚Çπ150</span><input type="radio" name="cat" value="Art & Craft"></div>
<div class="cat-row"><span>Recitation (11-25 yrs) - ‚Çπ150</span><input type="radio" name="cat" value="Recitation"></div>
<div class="cat-row"><span>Music (6-25 yrs) - ‚Çπ200</span><input type="radio" name="cat" value="Music"></div>
<div class="cat-row"><span>Dance (6-25 yrs) - ‚Çπ200</span><input type="radio" name="cat" value="Dance"></div>
<div class="cat-row"><span>Quiz (11-25 yrs) - ‚Çπ100 (No File Upload)</span><input type="radio" name="cat" value="Quiz"></div>
</div>

<label>Performance File (Not Needed For Quiz)</label>
<input type="file" id="performance" accept="video/*,audio/*,image/*">

<div class="terms-row">
<input type="checkbox" id="terms">
<label for="terms">I agree to <a href="terms.html" target="_blank">Terms & Conditions & Digital Consent</a></label>
</div>

<button onclick="submitForm()">Submit & Pay</button>

<p class="notice">
‚ö† Age eligibility: Strictly **6 to 25 years** on **01-Jan-2026**.<br>
‚ùå Even **6y + 1 day** or **25y + 1 day** is NOT allowed.<br>
üìÖ **Allowed DOB ‚Üí 01/01/2000 to 01/01/2020**
</p>
</div>


<script>
/* üî• UPDATED API */
const API_URL = "https://register-worker.sitalamaashyamashree.workers.dev";
const RAZORPAY_KEY = "rzp_live_Rj6ceV2avDzdlC";

/* STRICT DOB RULES & AGE CHECK CALC */
function strictDateCheck(dob){
    const input=new Date(dob),min=new Date("2000-01-01"),max=new Date("2020-01-01");
    if(input<min)return"‚ùå Age above 25 not allowed (DOB before 01/01/2000)";
    if(input>max)return"‚ùå Age below 6 not allowed (DOB after 01/01/2020)";
    if(input.getFullYear()===2000&&input>min)return"‚ùå 25y +1 day not allowed";
    if(input.getFullYear()===2020&&input>max)return"‚ùå 6y +1 day not allowed";
    return"";
}
function calculateAgeStrict(dob){
    const b=new Date(dob),r=new Date("2026-01-01");
    let a=r.getFullYear()-b.getFullYear(),m=r.getMonth()-b.getMonth(),d=r.getDate()-b.getDate();
    if(m<0||(m===0&&d<0))a--;return a;
}

/* CATEGORY VISIBILITY BY AGE */
function liveDOBCheck(){
    let d=document.getElementById("dob").value,e=document.getElementById("dobError"),i=document.getElementById("dob");
    e.innerHTML="";i.classList.remove("invalid");if(!d)return;
    let chk=strictDateCheck(d);if(chk!==""){e.innerHTML=chk;i.classList.add("invalid");hideAll();return;}
    let age=calculateAgeStrict(d);age<11?showLimited():showAll();
}
function showLimited(){
    document.querySelectorAll(".cat-row").forEach(r=>r.style.display="none");
    document.querySelector('[value="Music"]').parentNode.style.display="flex";
    document.querySelector('[value="Dance"]').parentNode.style.display="flex";
}
function showAll(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="flex");}
function hideAll(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="none");}

/* FEE SYSTEM */
function getFee(c){return c==="Quiz"?100:(c==="Dance"||c==="Music"?200:150);}

/* FILE UPLOAD */
async function uploadFile(file,cat){
    const fd=new FormData();fd.append("file",file);fd.append("category",cat);
    const res=await fetch(API_URL+"?action=upload",{method:"POST",body:fd});
    return res.json();
}

/* SUBMIT FORM */
async function submitForm(){
    if(document.getElementById("dobError").innerHTML!=="")return alert("‚ùå Fix DOB first");
    const dobV=document.getElementById("dob").value.trim(),
    nameV=document.getElementById("name").value.trim(),
    guardV=document.getElementById("guardian").value.trim(),
    relV=document.getElementById("relation").value.trim(),
    mobV=document.getElementById("mobile").value.trim(),
    emailV=document.getElementById("email").value.trim(),
    instV=document.getElementById("institution").value.trim()||"Not Provided",
    cat=document.querySelector("input[name='cat']:checked")?.value;

    if(!nameV||!guardV||!relV||!mobV||!dobV)return alert("‚ö† Fill required fields");
    if(!cat)return alert("‚ö† Select a category");
    if(!terms.checked)return alert("‚ö† Accept Terms & Conditions");

    const fee=getFee(cat);let fileUrl="No Upload Needed";
    if(cat!=="Quiz"){
        const f=document.getElementById("performance").files[0];
        if(!f)return alert("‚ö† Upload performance file");
        const up=await uploadFile(f,cat);
        if(up.status!=="success")return alert("‚ùå Upload error");fileUrl=up.fileUrl;
    }

    const user={
        name:nameV, guardian:guardV, relation:relV,
        mobile:mobV, email:emailV, dob:dobV, institution:instV,
        category:cat, fee, age:calculateAgeStrict(dobV), fileUrl
    };
    payNow(user);
}

/* RAZORPAY PAYMENT */
function payNow(user){
const opt={
    key:RAZORPAY_KEY,amount:user.fee*100,currency:"INR",name:"Competition Registration",
    handler:function(r){
        user.payment_id=r.razorpay_payment_id;
        fetch(API_URL+"?action=register",{
            method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify(user)
        })
        .then(r=>r.json())
        .then(d=>{if(d.status==="success"){
            alert("üéâ Registered Successfully!\nCode: "+d.code);
            window.location.href="success.html?code="+d.code+"&pdf="+d.pdfUrl;
        } else alert("‚ùå "+d.message);});
    }
};
new Razorpay(opt).open();
}

/* TEMPORARY OTP */
function sendOTP(){alert("üì© OTP will be added after SMS gateway setup.");}
</script>


</body>
</html>
