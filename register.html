<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Competition Registration</title>

<style>
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#dfe9ff,#f6f9ff);
  margin:0; padding:0;
}
.container{
  max-width: 600px;
  margin: 35px auto;
  background: #ffffff;
  padding: 30px;
  border-radius: 14px;
  box-shadow: 0 10px 25px rgba(0,0,0,.08);
  animation: fade .6s ease-in-out;
}
@keyframes fade{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
h2{
  text-align:center;
  margin-bottom:25px;
  color:#133b8c;
  font-size:28px;
  font-weight:700;
  letter-spacing:.5px;
}
label{font-weight:600;margin-top:12px;display:block;color:#333;}
input, select{
  width:100%;padding:12px;margin-top:6px;border:1px solid #c7c7c7;border-radius:6px;
  font-size:16px;background:#fafafa;
}
input:focus, select:focus{
  border-color:#0057ff;outline:none;background:white;
  box-shadow:0 0 6px rgba(0,87,255,.3);
}
button{
  width:100%;background:#0057ff;color:#fff;padding:15px;font-size:18px;font-weight:600;
  border:none;border-radius:8px;cursor:pointer;margin-top:20px;transition:.2s;
}
button:hover{background:#003bbd;transform:scale(1.02);}
.terms{margin-top:18px;font-size:14px;line-height:20px;}
.cat-wrap{background:#f2f5ff;padding:10px 14px;border-left:4px solid #2b56ff;margin-top:8px;border-radius:6px;}
#performance{background:white;border:1px dashed #aaa;}
#errorBox{
  margin-top:10px;
  padding:10px;
  color:#fff;
  background:#d40000;
  border-radius:6px;
  font-weight:600;
  display:none;
}
@media(max-width:480px){
  .container{padding:20px;margin:15px;}
  h2{font-size:22px;}
  input,select{font-size:15px;padding:10px;}
  button{font-size:16px;padding:12px;}
}
</style>
</head>

<body>
<div class="container">
<h2>Competition Registration</h2>

<label>Name *</label>
<input id="name">

<label>Guardian Name *</label>
<input id="guardian">

<label>Relation *</label>
<select id="relation">
<option value="">Select</option>
<option>Father</option><option>Mother</option><option>Brother</option><option>Sister</option><option>Other</option>
</select>

<label>Mobile *</label>
<input id="mobile" maxlength="10">

<label>Email *</label>
<input id="email">

<label>Date of Birth *</label>
<input type="date" id="dob">

<div id="errorBox"></div> <!-- üî• AGE ERROR SHOWS HERE -->

<label>School / Institute (Optional)</label>
<input id="institution">

<div class="cat-wrap">
<label>Category *</label>
<select id="category">
<option value="">-- Select Category --</option>
<option value="Art">Art & Craft (11-25) - ‚Çπ150</option>
<option value="Recitation">Recitation (11-25) - ‚Çπ150</option>
<option value="Music">Music (6-25) - ‚Çπ200</option>
<option value="Dance">Dance (6-25) - ‚Çπ200</option>
<option value="Quiz">Quiz (11-25) - ‚Çπ100 (No Upload)</option>
</select>
</div>

<label>Performance File (Not For Quiz)</label>
<input type="file" id="performance" accept="video/*">

<p class="terms"><input type="checkbox" id="terms"> I agree to Terms & Conditions</p>

<button onclick="submitForm()">Submit & Pay</button>
</div>









  <!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
// üéØ FIELD BINDING
const nameField = document.getElementById("name");
const guardianField = document.getElementById("guardian");
const relationField = document.getElementById("relation");
const mobileField = document.getElementById("mobile");
const emailField = document.getElementById("email");
const dobField = document.getElementById("dob");
const institutionField = document.getElementById("institution");
const categoryField = document.getElementById("category");
const performanceField = document.getElementById("performance");
const termsField = document.getElementById("terms");
const errorBox = document.getElementById("errorBox");

// üéØ API URL (Do Not Change)
const API_URL = "https://register-worker.sitalamaashyamashree.workers.dev";

// üéØ DO NOT CHANGE AGE LOGIC
function getAge(d){ return new Date("2026-01-01").getFullYear() - new Date(d).getFullYear(); }

// üéØ FEE LOGIC FOR YOUR CATEGORY VALUES
function fee(c){
  c = c.trim(); // ‚≠ê Prevent space mismatch
  return c==="Quiz" ? 100 :
         (c==="Dance" || c==="Music") ? 200 :
         150;
}

// üéØ UPLOAD FILE
async function uploadFile(file){
  let form = new FormData();
  form.append("file", file);

  let response = await fetch(API_URL+"?action=upload", {
    method:"POST",
    body: form
  });

  let text = await response.text(); // JSON ‡¶¨‡¶æ HTML ‡¶Ø‡¶æ‡¶á ‡¶Ü‡¶∏‡ßÅ‡¶ï ‡¶ß‡¶∞‡¶æ ‡¶™‡ßú‡¶¨‡ßá

  try {
    return JSON.parse(text); // ‚úî JSON ‡¶π‡¶≤‡ßá ‡¶†‡¶ø‡¶ï‡¶Æ‡¶§‡ßã ‡¶ö‡¶≤‡¶¨‡ßá
  } catch {
    return {
      status:"error",
      message:"‚ùå Upload failed - Server returned HTML, not JSON",
      raw: text.substring(0,100) // Debug info (HTML ‡¶è‡¶∞ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶Ö‡¶Ç‡¶∂)
    };
  }
}

// üéØ SUBMIT FORM
async function submitForm(){

 let data = {
   name: nameField.value.trim(),
   guardian: guardianField.value.trim(),
   relation: relationField.value.trim(),
   mobile: mobileField.value.trim(),
   email: emailField.value.trim(),
   dob: dobField.value.trim(),
   institution: institutionField.value.trim() || "Not Provided",
   category: categoryField.value.trim()
 };

 // BASIC VALIDATION
 if(!data.name||!data.guardian||!data.relation||!data.mobile||!data.email||!data.dob)
   return showError("‚ö† Please fill all required fields");

 if(!/^[0-9]{10}$/.test(data.mobile)) return showError("‚ö† Enter valid 10-digit mobile number");
 if(!/\S+@\S+\.\S+/.test(data.email)) return showError("‚ö† Enter valid email");
 if(!termsField.checked) return showError("‚ö† Accept terms to continue");
 if(!data.category) return showError("‚ö† Select a category");

 // AGE CHECK (NO CHANGE)
 let age = getAge(data.dob);
 if(age < 6 || age > 25){
   dobField.style.border="2px solid red";
   return showError("‚ùå Age must be 6 to 25 years (as on 01 January 2026)");
 }
 dobField.style.border="1px solid #ccc";

 // ‚≠ê FIXED FEE PROBLEM (converted to NUMBER)
data.category = data.category.trim().split(" ")[0]; // ‚≠ê Category normalization
data.fee = Number(fee(data.category));              // ‚≠ê Fee numeric
console.log("CHECK FEE BEFORE SENDING:", data.fee); // ‚≠ê Debug check

 data.fileUrl = "No Upload";

 // üìå QUIZ SKIPS UPLOAD
 if(data.category !== "Quiz"){
   let file = performanceField.files[0];
   if(!file) return showError("‚ö† Please upload your performance video");
   let up = await uploadFile(file);
   if(up.status !== "success") return showError("‚ùå Upload failed");
   data.fileUrl = up.fileUrl;
 }

 // üí≥ CREATE ORDER (‚Çπ ‚Üí Not ‚Çπ1 anymore)
 let order = await fetch(API_URL+"?action=create-order", {
   method:"POST",
   headers:{ "Content-Type":"application/json" },
   body: JSON.stringify({ amount: Number(data.fee) }) // ‚≠ê FIXED
 }).then(r=>r.json());

 // ‚≠ê RAZORPAY CHECKOUT
 let pay = new Razorpay({
   key: "rzp_live_Rj6ceV2avDzdlC", // YOUR KEY
   order_id: order.id,
   amount: order.amount,
   currency: "INR",
   name:"Competition Registration",
   description:"Entry Fee Payment",
   handler: async function(res){
     data.payment_id = res.razorpay_payment_id;

     let submit = await fetch(API_URL+"?action=register",{
       method:"POST",
       headers:{ "Content-Type":"application/json" },
       body: JSON.stringify(data)
     }).then(r=>r.json());

     if(submit.status === "success"){
       window.location.href = "success.html?code="+submit.code+"&pdf="+submit.pdfUrl;
     } else {
       alert("‚ùå Something went wrong: "+submit.message);
     }
   }
 });

 pay.open();
}

// üéØ ERROR MESSAGE UI
function showError(msg){
 errorBox.style.display="block";
 errorBox.innerText = msg;
}
</script>

</body>
</html>
