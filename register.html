<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Competition Registration</title>
<style>
body{font-family:Arial;background:#f6f6f9;margin:0;padding:0;}
.container{max-width:560px;margin:20px auto;background:white;padding:25px;border-radius:10px;box-shadow:0 0 8px rgba(0,0,0,0.1);}
input,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:6px;}
button{width:100%;background:#0057ff;color:white;padding:14px;border:0;border-radius:6px;font-size:18px;margin-top:15px;cursor:pointer;}
.cat-box{padding:10px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px;}
</style>
</head>
<body>

<div class="container">
<h2><center>Competition Registration</center></h2>

<input id="name" placeholder="Full Name *" required>
<input id="guardian" placeholder="Guardian Name *" required>
<input id="relation" placeholder="Relation (Father/Mother/Other) *" required>
<input id="mobile" placeholder="Mobile No *" required>
<input id="email" placeholder="Email *" required>
<input id="dob" type="date" required>
<input id="institution" placeholder="School / Institute (Optional)">

<h3>Category *</h3>
<div class="cat-box"><input type="radio" name="cat" value="Art"> Art & Craft (11-25) - ‚Çπ150</div>
<div class="cat-box"><input type="radio" name="cat" value="Recitation"> Recitation (11-25) - ‚Çπ150</div>
<div class="cat-box"><input type="radio" name="cat" value="Music"> Music (6-25) - ‚Çπ200</div>
<div class="cat-box"><input type="radio" name="cat" value="Dance"> Dance (6-25) - ‚Çπ200</div>
<div class="cat-box"><input type="radio" name="cat" value="Quiz"> Quiz (11-25) - ‚Çπ100 (No File)</div>

<h3>Performance File (Not for Quiz)</h3>
<input id="performance" type="file">

<label><input type="checkbox" id="terms"> I agree to Terms & Conditions</label>

<button onclick="submitForm()">Submit & Pay</button>
</div>

<script>
const API_URL = "https://register-worker.sitalamaashyamashree.workers.dev/";
const RAZORPAY_KEY = "rzp_live_Rj6ceV2avDzdlC";

function fee(c){
 if(c==="Art"||c==="Recitation")return 150;
 if(c==="Music"||c==="Dance")return 200;
 if(c==="Quiz")return 100;
}

function getAge(d){
 let a=new Date().getFullYear()-new Date(d).getFullYear();
 return a;
}

// ‚úÖ FILE UPLOAD FIXED
async function uploadFile(file, category){
 let formData=new FormData();
 formData.append("file",file);
 formData.append("action","upload");
 formData.append("category",category);

 let r=await fetch(API_URL+"?action=upload",{
   method:"POST",
   body: formData
 });

 try{return await r.json();}
 catch{return{status:"error",message:"‚ùå Invalid response"}}
}

// üöÄ FINAL SUBMIT FUNCTION
async function submitForm(){
 let nameField=document.getElementById("name");
 let guardianField=document.getElementById("guardian");
 let relationField=document.getElementById("relation");
 let mobileField=document.getElementById("mobile");
 let emailField=document.getElementById("email");
 let dobField=document.getElementById("dob");
 let institutionField=document.getElementById("institution");

 let data={
   name:nameField.value.trim(),
   guardian:guardianField.value.trim(),
   relation:relationField.value.trim(),
   mobile:mobileField.value.trim(),
   email:emailField.value.trim(),
   dob:dobField.value.trim(),
   institution:institutionField.value.trim()||"Not Provided",
   category:document.querySelector("input[name='cat']:checked")?.value
 };

 if(!data.name||!data.guardian||!data.relation||!data.mobile||!data.dob) return alert("‚ö† Required fields missing");
 if(!data.category) return alert("‚ö† Select category first");
 if(!terms.checked) return alert("‚ö† Accept terms first");

 data.fee=fee(data.category);
 data.fileUrl="No File";

 if(data.category!=="Quiz"){
   let file=document.getElementById("performance").files[0];
   if(!file)return alert("‚ö† Upload file first");
   let up=await uploadFile(file,data.category);
   if(up.status!=="success")return alert("‚ùå Upload Failed: "+up.message);
   data.fileUrl=up.fileUrl;
 }

 let rz=new Razorpay({
   key:RAZORPAY_KEY,
   amount:data.fee*100,
   name:"Competition Registration",
   handler:(r)=>{
     data.payment_id=r.razorpay_payment_id;
     fetch(API_URL+"?action=register",{
       method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)
     }).then(r=>r.json()).then(x=>{
       if(x.status==="success"){alert("üéâ Registered! Code: "+x.code);window.location="success.html";}
       else alert("‚ùå "+x.message);
     })
   }
 });

 rz.open();
}
</script>

</body>
</html>
