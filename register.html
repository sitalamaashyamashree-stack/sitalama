<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Competition Registration</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
body{font-family:Arial, sans-serif;background:#eef1f5;margin:0;padding:0;}
.container{width:95%;max-width:600px;margin:40px auto;background:#fff;
padding:30px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);}
h2{text-align:center;font-size:26px;margin-bottom:20px;}
label{display:block;margin:10px 0 5px;font-weight:600;}
input,select{width:100%;padding:12px;border:1px solid #ccc;border-radius:8px;
background:#f8f9fb;font-size:16px;}
.category-list{border:1px solid #ddd;border-radius:10px;background:#fafafa;
padding:10px 15px;margin-top:8px;}
.cat-row{display:flex;justify-content:space-between;align-items:center;
padding:10px 0;border-bottom:1px solid #eee;}
.cat-row:last-child{border-bottom:none;}
.cat-row input{width:22px;height:22px;cursor:pointer;}
button{width:100%;padding:15px;background:#0D6EFD;color:white;border:none;
border-radius:10px;font-size:18px;font-weight:bold;cursor:pointer;margin-top:20px;}
button:hover{background:#094eb3;}
.terms-row{display:flex;align-items:center;gap:10px;margin-top:15px;font-size:15px;}
.error-msg{color:red;font-size:14px;margin-top:4px;font-weight:600;}
#ageDisplay{font-size:15px;margin-top:5px;color:#0d6efd;font-weight:600;}
.invalid{border:2px solid red !important;}
</style>
</head>

<body>
<div class="container">

<h2>Competition Registration</h2>

<label>Name *</label>
<input id="name"/>

<label>Guardian Name *</label>
<input id="guardian"/>

<label>Relation *</label>
<select id="relation">
<option value="">-- Select --</option><option>Father</option><option>Mother</option><option>Other</option>
</select>

<label>Mobile No *</label>
<input id="mobile" type="number"/>

<label>Email *</label>
<input id="email" type="email"/>

<label>Date of Birth *</label>
<input type="date" id="dob" oninput="liveDOBCheck()"/>
<div id="ageDisplay"></div>
<div id="dobError" class="error-msg"></div>

<label>School / Institute (Optional)</label>
<input id="institution"/>

<label>Category *</label>
<div class="category-list">
<div class="cat-row"><span>Art & Craft (11-25) - ‚Çπ150</span><input type="radio" name="cat" value="Art & Craft"></div>
<div class="cat-row"><span>Recitation (11-25) - ‚Çπ150</span><input type="radio" name="cat" value="Recitation"></div>
<div class="cat-row"><span>Music (6-25) - ‚Çπ200</span><input type="radio" name="cat" value="Music"></div>
<div class="cat-row"><span>Dance (6-25) - ‚Çπ200</span><input type="radio" name="cat" value="Dance"></div>
<div class="cat-row"><span>Quiz (11-25) - ‚Çπ100 (No File)</span><input type="radio" name="cat" value="Quiz"></div>
</div>

<label>Performance File (not needed for Quiz)</label>
<input type="file" id="performance" accept="video/*,image/*,audio/*"/>

<div class="terms-row">
<input type="checkbox" id="terms"/> 
<label>I agree to <a href="terms.html" target="_blank">Terms & Conditions</a></label>
</div>

<button onclick="submitForm()">Submit & Pay</button>

<p class="notice" style="text-align:center;margin-top:15px;">
‚ö† Strict Age: **6 to 25 years only** as on **01 Jan 2026**<br>
‚ùå Even **6y+1day / 25y+1day NOT allowed**<br>
üìÖ Allowed DOB: **01/01/2000 to 01/01/2020**
</p>

</div>

<script>
/* üî• API URL & PAYMENT KEY */
const API_URL = "https://register-worker.sitalamaashyamashree.workers.dev";
const RAZORPAY_KEY = "rzp_live_Rj6ceV2avDzdlC";

/* DOB STRICT CHECK + LIVE AGE DISPLAY */
function strictCheck(d){
let i=new Date(d),min=new Date("2000-01-01"),max=new Date("2020-01-01");
if(i<min)return"‚ùå Above 25 years not allowed";
if(i>max)return"‚ùå Below 6 years not allowed";
if(i.getFullYear()===2000&&i>min)return"‚ùå 25y +1 day not allowed";
if(i.getFullYear()===2020&&i>max)return"‚ùå 6y +1 day not allowed";
return"";
}
function getAge(d){
const b=new Date(d),r=new Date("2026-01-01");
let a=r.getFullYear()-b.getFullYear(),
m=r.getMonth()-b.getMonth(),da=r.getDate()-b.getDate();
if(m<0||(m===0&&da<0))a--;return a;
}

/* CATEGORY CONTROL */
function liveDOBCheck(){
let d=document.getElementById("dob").value;
let err=document.getElementById("dobError");
let ageBox=document.getElementById("ageDisplay");
err.innerHTML=""; ageBox.innerHTML=""; 
document.getElementById("dob").classList.remove("invalid");
if(!d)return;

let check=strictCheck(d);
if(check!==""){
 err.innerHTML=check;
 document.getElementById("dob").classList.add("invalid");
 hideCategory();
 return;
}

let age=getAge(d);
ageBox.innerHTML="üéØ Age on 01/01/2026: <b>"+age+" Years</b>";

if(age<11) showChild(); else showAll();
}
function hideCategory(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="none");}
function showChild(){
hideCategory();
document.querySelector('[value="Music"]').parentNode.style.display="flex";
document.querySelector('[value="Dance"]').parentNode.style.display="flex";
}
function showAll(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="flex");}

/* FEE */
function fee(c){return c==="Quiz"?100:(c==="Dance"||c==="Music"?200:150);}

/* UPLOAD */
async function uploadFile(file,cat){
let fd=new FormData(); fd.append("file",file);
return fetch(API_URL+"?action=upload",{method:"POST",body:fd})
.then(r=>r.text()).then(t=>JSON.parse(t));
}

/* SUBMIT */
async function submitForm(){
let nameF=document.getElementById("name").value.trim();
let guardF=document.getElementById("guardian").value.trim();
let relF=document.getElementById("relation").value.trim();
let mobF=document.getElementById("mobile").value.trim();
let emailF=document.getElementById("email").value.trim();
let dobF=document.getElementById("dob").value.trim();
let instF=document.getElementById("institution").value.trim()||"Not Provided";
let cat=document.querySelector("input[name='cat']:checked")?.value;

if(!nameF||!guardF||!relF||!mobF||!dobF) return alert("‚ö† Fill all required fields");
if(!cat) return alert("‚ö† Select category");
if(!terms.checked) return alert("‚ö† Accept Terms first");

let f = fee(cat);
let age = getAge(dobF);

let fileUrl="No Upload Needed";
if(cat!=="Quiz"){
 let file=document.getElementById("performance").files[0];
 if(!file) return alert("‚ö† Upload file required");
 let up=await uploadFile(file,cat);
 if(up.status!=="success") return alert("‚ùå Upload failed");
 fileUrl=up.fileUrl;
}

let user={
 name:nameF,guardian:guardF,relation:relF,mobile:mobF,email:emailF,dob:dobF,
 institution:instF,category:cat,fee:f,age,fileUrl
};

/* PAYMENT */
let rz=new Razorpay({
key:RAZORPAY_KEY,amount:f*100,name:"Competition Registration",
handler:(r)=>{
 user.payment_id=r.razorpay_payment_id;
 fetch(API_URL+"?action=register",{
   method:"POST",headers:{"Content-Type":"application/json"},
   body:JSON.stringify(user)
 })
 .then(r=>r.text()).then(t=>JSON.parse(t))
 .then(x=>{
   if(x.status==="success"){
     alert("üéâ Registered!\nCode: "+x.code);
     window.location="success.html?code="+x.code+"&pdf="+x.pdfUrl;
   } else alert("‚ùå "+x.message);
 });
}});
rz.open();
}
</script>
</body>
</html>
