<script>
/* üî• UPDATED API */
const API_URL = "https://register-worker.sitalamaashyamashree.workers.dev";
const RAZORPAY_KEY = "rzp_live_Rj6ceV2avDzdlC";

/* STRICT DOB RULES & AGE CHECK CALC */
function strictDateCheck(dob){
    const input=new Date(dob),min=new Date("2000-01-01"),max=new Date("2020-01-01");
    if(input<min)return"‚ùå Age above 25 not allowed (DOB before 01/01/2000)";
    if(input>max)return"‚ùå Age below 6 not allowed (DOB after 01/01/2020)";
    if(input.getFullYear()===2000&&input>min)return"‚ùå 25y +1 day not allowed";
    if(input.getFullYear()===2020&&input>max)return"‚ùå 6y +1 day not allowed";
    return"";
}
function calculateAgeStrict(dob){
    const b=new Date(dob),r=new Date("2026-01-01");
    let a=r.getFullYear()-b.getFullYear(),m=r.getMonth()-b.getMonth(),d=r.getDate()-b.getDate();
    if(m<0||(m===0&&d<0))a--;return a;
}

/* CATEGORY VISIBILITY BY AGE */
function liveDOBCheck(){
    let d=document.getElementById("dob").value,e=document.getElementById("dobError"),i=document.getElementById("dob");
    e.innerHTML="";i.classList.remove("invalid");if(!d)return;
    let chk=strictDateCheck(d);if(chk!==""){e.innerHTML=chk;i.classList.add("invalid");hideAll();return;}
    let age=calculateAgeStrict(d);age<11?showLimited():showAll();
}
function showLimited(){
    document.querySelectorAll(".cat-row").forEach(r=>r.style.display="none");
    document.querySelector('[value="Music"]').parentNode.style.display="flex";
    document.querySelector('[value="Dance"]').parentNode.style.display="flex";
}
function showAll(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="flex");}
function hideAll(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="none");}

/* FEE SYSTEM */
function getFee(c){return c==="Quiz"?100:(c==="Dance"||c==="Music"?200:150);}

/* FILE UPLOAD (FIXED JSON ISSUE) */
async function uploadFile(file,cat){
    const fd=new FormData();fd.append("file",file);fd.append("category",cat);
    return fetch(API_URL+"?action=upload",{method:"POST",body:fd})
    .then(r=>r.text()).then(t=>JSON.parse(t));
}

/* SUBMIT FORM (FIXED JSON ISSUE) */
async function submitForm(){
    if(document.getElementById("dobError").innerHTML!=="")return alert("‚ùå Fix DOB first");
    const dobV=document.getElementById("dob").value.trim(),
    nameV=document.getElementById("name").value.trim(),
    guardV=document.getElementById("guardian").value.trim(),
    relV=document.getElementById("relation").value.trim(),
    mobV=document.getElementById("mobile").value.trim(),
    emailV=document.getElementById("email").value.trim(),
    instV=document.getElementById("institution").value.trim()||"Not Provided",
    cat=document.querySelector("input[name='cat']:checked")?.value;

    if(!nameV||!guardV||!relV||!mobV||!dobV)return alert("‚ö† Fill required fields");
    if(!cat)return alert("‚ö† Select a category");
    if(!terms.checked)return alert("‚ö† Accept Terms & Conditions");

    const fee=getFee(cat);let fileUrl="No Upload Needed";
    if(cat!=="Quiz"){
        const f=document.getElementById("performance").files[0];
        if(!f)return alert("‚ö† Upload performance file");
        const up=await uploadFile(f,cat);
        if(up.status!=="success")return alert("‚ùå Upload error");fileUrl=up.fileUrl;
    }

    const user={
        name:nameV, guardian:guardV, relation:relV,
        mobile:mobV, email:emailV, dob:dobV, institution:instV,
        category:cat, fee, age:calculateAgeStrict(dobV), fileUrl
    };
    payNow(user);
}

/* RAZORPAY PAYMENT (FIXED JSON ISSUE) */
function payNow(user){
const opt={
    key:RAZORPAY_KEY,amount:user.fee*100,currency:"INR",name:"Competition Registration",
    handler:function(r){
        user.payment_id=r.razorpay_payment_id;
        fetch(API_URL+"?action=register",{
            method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify(user)
        })
        .then(r=>r.text())          // <- FIXED
        .then(t=>JSON.parse(t))     // <- FIXED JSON PARSE
        .then(d=>{
            if(d.status==="success"){
                alert("üéâ Registered Successfully!\nCode: "+d.code);
                window.location.href="success.html?code="+d.code+"&pdf="+d.pdfUrl;
            } else alert("‚ùå "+d.message);
        });
    }
};
new Razorpay(opt).open();
}

/* TEMPORARY OTP */
function sendOTP(){alert("üì© OTP will be added after SMS gateway setup.");}
</script>
