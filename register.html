<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Competition Registration</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
body{
  font-family:'Poppins',sans-serif;background:#eef1f7;
  display:flex;justify-content:center;margin:0;padding:20px;
}
.container{
  background:white;width:95%;max-width:600px;padding:25px;
  border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.1);
}
h2{text-align:center;color:#0d47a1;margin-bottom:15px;}
label{font-weight:500;margin-top:10px;display:block;}
input,select{
  width:100%;padding:12px;border-radius:6px;border:1px solid #ccc;
  font-size:16px;margin-top:5px;
}
input:focus,select:focus{border-color:#0d47a1;outline:none;}
button{
  width:100%;padding:15px;font-size:18px;border:none;border-radius:8px;
  background:#0d47a1;color:white;margin-top:20px;cursor:pointer;
}
button:hover{background:#08306b;}
#errorBox{
  display:none;background:#ffe6e6;color:#b00000;border-left:5px solid red;
  padding:10px;margin-bottom:12px;border-radius:6px;font-weight:600;
}
  /* ============================
   TERMS & CONDITIONS STYLING
   ============================ */
.terms-box{
  margin-top: 15px;
}

.terms-label{
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 15px;
  color: #333;
  cursor: pointer;
}

.terms-label input{
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.terms-label a{
  color: #0d47a1;
  text-decoration: underline;
  font-weight: 500;
}

.terms-label a:hover{
  color: #08306b;
}

</style>
</head>

<body>
<div class="container">
<h2>Competition Registration</h2>
<div id="errorBox"></div>

<label>Name *</label><input id="name" type="text">
<label>Guardian Name *</label><input id="guardian" type="text">

<label>Relation *</label>
<select id="relation">
  <option value="">-- Select Relation --</option>
  <option value="Father">Father</option>
  <option value="Mother">Mother</option>
  <option value="Brother">Brother</option>
  <option value="Sister">Sister</option>
  <option value="Guardian">Guardian</option>
</select>

<label>Mobile *</label><input id="mobile" maxlength="10" placeholder="10 digit mobile">
<label>Email *</label><input id="email" type="email">
<label>Date of Birth *</label><input id="dob" type="date">
<label>School / Institute /collage </label><input id="institution" type="text">

<label>Category *</label>
<select id="category">
  <option value="">-- Select Category --</option>
  <option value="Art">Art (11-25) - ₹150</option>
  <option value="Recitation">Recitation (11-25) - ₹150</option>
  <option value="Music">Music (6-25) - ₹200</option>
  <option value="Dance">Dance (6-25) - ₹200</option>
  <option value="Quiz">Quiz (11-25) - ₹100</option>
</select>

<br><br>
<div class="terms-box">
  <label class="terms-label">
    <input type="checkbox" id="terms">
    <span>
      I agree to the
      <a href="https://talenthunt.ssmctrust.org/policies/privacy-policy"
         target="_blank"
         rel="noopener">
        Terms & Conditions
      </a>
    </span>
  </label>
</div>

<button onclick="submitForm()">Submit & Pay</button>
</div>
<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
// ============================
// FIELD BINDING
// ============================
const nameField = document.getElementById("name");
const guardianField = document.getElementById("guardian");
const relationField = document.getElementById("relation");
const mobileField = document.getElementById("mobile");
const emailField = document.getElementById("email");
const dobField = document.getElementById("dob");
const institutionField = document.getElementById("institution");
const categoryField = document.getElementById("category");
const termsField = document.getElementById("terms");
const errorBox = document.getElementById("errorBox");
const ageMessage = document.getElementById("ageMessage");

const API_URL = "https://register-worker.sitalamaashyamashree.workers.dev"; // DO NOT CHANGE


// ============================
// DOB RANGE CHECK
// ============================
function isDobInAllowedRange(dobStr){
  const dob = new Date(dobStr);
  return dob >= new Date("2001-01-01") && dob <= new Date("2026-01-01");
}


// ============================
// EXACT AGE CALCULATION
// ============================
function calculateExactAge(dobStr){
  const dob = new Date(dobStr);
  const ref = new Date("2026-01-01");

  let years = ref.getFullYear() - dob.getFullYear();
  let months = ref.getMonth() - dob.getMonth();
  let days = ref.getDate() - dob.getDate();

  if(days < 0){
    months--;
    const prevMonth = new Date(ref.getFullYear(), ref.getMonth(), 0);
    days += prevMonth.getDate();
  }

  if(months < 0){
    years--;
    months += 12;
  }

  return { years, months, days };
}


// ============================
// AGE GROUP LOGIC
// ============================
function getAgeGroup(years){
  if(years >= 6 && years <= 12) return "Junior";
  if(years >= 13 && years <= 17) return "Mid Age";
  if(years >= 18 && years <= 25) return "Senior";
  return "Not Eligible";
}


// ============================
// CATEGORY FILTER BY AGE GROUP
// ============================
function filterCategoriesByAgeGroup(ageGroup){
  const options = categoryField.options;

  for(let i = 0; i < options.length; i++){
    const val = options[i].value;
    if(!val) continue;

    options[i].style.display = "block";

    // Junior rule
    if(ageGroup === "Junior" && (val === "Recitation" || val === "Quiz")){
      options[i].style.display = "none";
    }
  }

  categoryField.value = "";
}


// ============================
// LIVE DOB VALIDATION
// ============================
dobField.addEventListener("input", ()=>{
  if(!dobField.value){
    ageMessage.innerText = "";
    dobField.style.border = "1px solid #ccc";
    return;
  }

  if(!isDobInAllowedRange(dobField.value)){
    dobField.style.border = "2px solid red";
    ageMessage.style.color = "red";
    ageMessage.innerHTML =
      "❌ DOB must be between <b>01-Jan-2001</b> and <b>01-Jan-2026</b>";
    return;
  }

  const age = calculateExactAge(dobField.value);
  const group = getAgeGroup(age.years);

  if(group === "Not Eligible"){
    dobField.style.border = "2px solid orange";
    ageMessage.style.color = "orange";
    ageMessage.innerHTML =
      `⚠ Age: ${age.years}Y ${age.months}M ${age.days}D<br>⚠ Not eligible`;
    return;
  }

  filterCategoriesByAgeGroup(group);

  dobField.style.border = "2px solid green";
  ageMessage.style.color = "green";
  ageMessage.innerHTML =
    `✔ Age: ${age.years}Y ${age.months}M ${age.days}D<br>
     ✔ Age Group: <b>${group}</b>`;
});


// ============================
// CATEGORY FEE LOGIC
// ============================
function fee(c){
  return c === "Quiz" ? 100 :
         (c === "Dance" || c === "Music") ? 200 :
         150;
}


// ============================
// ERROR MESSAGE
// ============================
function showError(msg){
  errorBox.style.display = "block";
  errorBox.innerText = msg;
  errorBox.style.color = "red";
}


// ============================
// FINAL SUBMIT & PAYMENT
// ============================
async function submitForm(){

  let data = {
    name: nameField.value.trim(),
    guardian: guardianField.value.trim(),
    relation: relationField.value.trim(),
    mobile: mobileField.value.trim(),
    email: emailField.value.trim(),
    dob: dobField.value.trim(),
    institution: institutionField.value.trim() || "Not Provided",
    category: categoryField.value.trim()
  };

  if(!data.name || !data.guardian || !data.relation ||
     !data.mobile || !data.email || !data.dob || !data.category)
    return showError("⚠ Please fill all required fields");

  if(!/^[0-9]{10}$/.test(data.mobile))
    return showError("⚠ Enter valid 10-digit phone number");

  if(!/\S+@\S+\.\S+/.test(data.email))
    return showError("⚠ Enter valid email address");

  if(!termsField.checked)
    return showError("⚠ Accept the Terms & Conditions to continue");

  if(!isDobInAllowedRange(data.dob))
    return showError("❌ DOB must be between 01-Jan-2001 and 01-Jan-2026");

  const ageObj = calculateExactAge(data.dob);
  const ageGroup = getAgeGroup(ageObj.years);

  if(ageGroup === "Not Eligible")
    return showError("❌ Candidate not eligible by age");

  filterCategoriesByAgeGroup(ageGroup);

  data.age = `${ageObj.years}Y ${ageObj.months}M ${ageObj.days}D`;
  data.age_group = ageGroup;

  data.category = data.category.split(" ")[0];
  data.fee = Number(fee(data.category));

  const order = await fetch(API_URL + "?action=create-order",{
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ amount: data.fee })
  }).then(r => r.json());

  const pay = new Razorpay({
    key: "rzp_live_Rj6ceV2avDzdlC",
    order_id: order.id,
    amount: order.amount,
    currency: "INR",
    name: "Competition Registration",
    handler: async function(res){

      data.payment_id = res.razorpay_payment_id;

      const submit = await fetch(API_URL + "?action=register",{
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then(r => r.json());

      if(submit.status === "success"){
        window.location.href =
          "success.html?code=" + submit.code + "&pdf=" + submit.pdfUrl;
      } else {
        showError("❌ " + submit.message);
      }
    }
  });

  pay.open();
}
</script>



</body>
</html>
