<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Competition Registration</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#eef2f7;
  margin:0; padding:0;
}
.container{
  max-width:520px;
  margin:25px auto;
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 0 12px rgba(0,0,0,0.10);
}
h2{ text-align:center; margin-bottom:20px; }

label{ font-weight:bold; display:block; margin-top:12px; }
input,select{
  width:100%;
  padding:10px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-top:6px;
  font-size:16px;
}
input.invalid{ border:2px solid red; }

.category-box{ margin:14px 0; }
.cat-row{
  display:flex; justify-content:space-between;
  padding:10px; margin:6px 0;
  border-radius:6px; background:#fafafa;
  border:1px solid #ddd;
}
.cat-row:hover{ background:#e7f1ff; }

#submitBtn{
  width:100%;
  padding:14px;
  background:#0056d6;
  color:white; border:none;
  border-radius:8px;
  margin-top:18px;
  font-size:18px; cursor:pointer;
}
#submitBtn:hover{ background:#0049b4; }

#dobError{color:red; font-size:14px; margin-top:6px;}
#ageDisplay{color:#0047b3; font-size:15px; margin-top:6px; }

.termsBox{
  display:flex; align-items:center;
  font-size:15px; margin-top:14px;
}
.termsBox a{ color:#0056d6; font-weight:bold; }
</style>
</head>
<body>

<div class="container">
<h2>Competition Registration</h2>

<!-- NAME -->
<label>Name *</label>
<input id="name" type="text">

<label>Guardian Name *</label>
<input id="guardian" type="text">

<label>Relation *</label>
<select id="relation">
<option value="">Select Relation</option>
<option>Father</option>
<option>Mother</option>
<option>Brother</option>
<option>Sister</option>
<option>Other</option>
</select>

<label>Mobile *</label>
<input id="mobile" maxlength="10" type="text">

<label>Email *</label>
<input id="email" type="email">

<label>Date of Birth *</label>
<input type="date" id="dob" onchange="liveDOBCheck()">
<div id="ageDisplay"></div>
<div id="dobError"></div>

<label>School / Institute (Optional)</label>
<input id="institution" placeholder="Optional">

<!-- CATEGORY -->
<label style="margin-top:20px;">Category *</label>
<div class="category-box">
<div class="cat-row"><span>Art & Craft (11-25) ‚Äì ‚Çπ150</span><input type="radio" name="cat" value="Art & Craft"></div>
<div class="cat-row"><span>Recitation (11-25) ‚Äì ‚Çπ150</span><input type="radio" name="cat" value="Recitation"></div>
<div class="cat-row"><span>Music (6-25) ‚Äì ‚Çπ200</span><input type="radio" name="cat" value="Music"></div>
<div class="cat-row"><span>Dance (6-25) ‚Äì ‚Çπ200</span><input type="radio" name="cat" value="Dance"></div>
<div class="cat-row"><span>Quiz (11-25) ‚Äì ‚Çπ100 (No File)</span><input type="radio" name="cat" value="Quiz"></div>
</div>

<label>Performance File (Not Needed for Quiz)</label>
<input type="file" id="performance" accept="video/*,image/*">

<!-- TERMS -->
<div class="termsBox">
<input type="checkbox" id="terms" style="width:18px; margin-right:10px;">
I agree to the <a href="terms.html" target="_blank">Terms & Conditions</a>
</div>

<button id="submitBtn" onclick="submitForm()">Submit & Pay</button>

<p style="font-size:13px; margin-top:15px; color:#444;">
‚ö† Age Limit: <b>6 to 25 years (STRICT) on 01-Jan-2026</b><br>
‚õî Even <b>6y+1day / 25y+1day NOT allowed</b><br>
üìå Allowed DOB: <b>01/01/2000 to 01/01/2020</b>
</p>

</div>

<!-- üìå RAZORPAY -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
/* ----------------------------------
   CONFIG
---------------------------------- */
const API_URL = "https://register-worker.sitalamaashyamashree.workers.dev";
const RAZORPAY_KEY = "rzp_live_Rj6ceV2avDzdlC";

/* ----------------------------------
   AGE LOGIC
---------------------------------- */
function strictCheck(d){
let i=new Date(d),min=new Date("2000-01-01"),max=new Date("2020-01-01");
if(i<min)return"‚ùå Above 25 years not allowed";
if(i>max)return"‚ùå Below 6 years not allowed";
if(i.getFullYear()===2000&&i>min)return"‚ùå 25y+1day not allowed";
if(i.getFullYear()===2020&&i>max)return"‚ùå 6y+1day not allowed";
return"";}

function getAge(d){
let b=new Date(d),r=new Date("2026-01-01");
let a=r.getFullYear()-b.getFullYear(),m=r.getMonth()-b.getMonth(),da=r.getDate()-b.getDate();
if(m<0||(m===0&&da<0))a--;return a;}

function liveDOBCheck(){
let d=dob.value,err=dobError,age=ageDisplay;
err.innerHTML="";age.innerHTML="";dob.classList.remove("invalid");
if(!d)return;
let c=strictCheck(d);if(c){err.innerHTML=c;dob.classList.add("invalid");hide();return;}
let ag=getAge(d);age.innerHTML="üéØ Age on 01/01/2026: <b>"+ag+" Years</b>";
if(ag<11)child();else show();}

function hide(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="none");}
function child(){hide();document.querySelector('[value=\"Music\"]').parentNode.style.display="flex";
document.querySelector('[value=\"Dance\"]').parentNode.style.display="flex";}
function show(){document.querySelectorAll(".cat-row").forEach(r=>r.style.display="flex");}
function fee(c){return c==="Quiz"?100:(c==="Dance"||c==="Music"?200:150);}

/* ----------------------------------
   üì§ FILE UPLOAD
---------------------------------- */
async function uploadFile(file, category){
const form=new FormData();
form.append("action","upload");
form.append("file",file);
form.append("category",category);

const r=await fetch(API_URL+"?action=upload",{method:"POST",body:form});
return await r.json();
}

/* ----------------------------------
   üì© SUBMIT + PAYMENT
---------------------------------- */
  async function submitForm(){

  // üîß FIX: CONNECT INPUT FIELDS FIRST
  const nameField        = document.getElementById("name");
  const guardianField    = document.getElementById("guardian");
  const relationField    = document.getElementById("relation");
  const mobileField      = document.getElementById("mobile");
  const emailField       = document.getElementById("email");
  const dobField         = document.getElementById("dob");
  const institutionField = document.getElementById("institution");

  let data = {
    name:        nameField?.value.trim(),
    guardian:    guardianField?.value.trim(),
    relation:    relationField?.value.trim(),
    mobile:      mobileField?.value.trim(),
    email:       emailField?.value.trim(),
    dob:         dobField?.value.trim(),
    institution: institutionField?.value.trim() || "Not Provided",
    category:    document.querySelector("input[name='cat']:checked")?.value
  };

  // üõë Required field checks
  if(!data.name || !data.guardian || !data.relation || !data.mobile || !data.dob)
    return alert("‚ö† Fill all required fields first");
  if(!data.category)
    return alert("‚ö† Select a category");
  if(!terms.checked)
    return alert("‚ö† Accept Terms First");

  data.fee = fee(data.category);
  data.age = getAge(data.dob);
  data.fileUrl = "No Upload";

  // üì© FILE UPLOAD (if not Quiz)
  if(data.category !== "Quiz"){
    const file = document.getElementById("performance").files[0];
    if(!file) return alert("‚ö† Please upload file");
    let up = await uploadFile(file, data.category);
    if(up.status !== "success") return alert("‚ùå Upload Failed: "+up.message);
    data.fileUrl = up.fileUrl;
  }

  // üí≥ PAYMENT BLOCK
  let rz = new Razorpay({
    key: RAZORPAY_KEY,
    amount: data.fee * 100,
    name: "Competition Registration",
    handler: (r)=>{

      data.payment_id = r.razorpay_payment_id;

      fetch(API_URL+"?action=register",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data)
      })
      .then(r=>r.json())
      .then(x=>{
        if(x.status === "success"){
          alert("üéâ Registered! Code: "+x.code);
          window.location = "success.html?code="+x.code+"&pdf="+x.pdfUrl;
        } else {
          alert("‚ùå "+x.message);
        }
      });

    }
  });

  rz.open();
}

/*async function submitForm(){

let data={
 name:name.value.trim(),
 guardian:guardian.value.trim(),
 relation:relation.value.trim(),
 mobile:mobile.value.trim(),
 email:email.value.trim(),
 dob:dob.value.trim(),
 institution:institution.value.trim()||"Not Provided",
 category:document.querySelector("input[name='cat']:checked")?.value
};

if(!data.name||!data.guardian||!data.relation||!data.mobile||!data.dob)
 return alert("‚ö† Fill all required fields first");
if(!data.category) return alert("‚ö† Select a category");
if(!terms.checked) return alert("‚ö† Accept Terms First");

data.fee=fee(data.category);
data.age=getAge(data.dob);
data.fileUrl="No Upload";

if(data.category!=="Quiz"){
 const file=document.getElementById("performance").files[0];
 if(!file)return alert("‚ö† Please upload file");
 let up=await uploadFile(file,data.category);
 if(up.status!=="success")return alert("‚ùå Upload Failed: "+up.message);
 data.fileUrl=up.fileUrl;
}

let rz=new Razorpay({
 key:RAZORPAY_KEY,
 amount:data.fee*100,
 name:"Competition Registration",
 handler:(r)=>{
   data.payment_id=r.razorpay_payment_id;
   fetch(API_URL+"?action=register",{
     method:"POST",headers:{"Content-Type":"application/json"},
     body:JSON.stringify(data)
   }).then(r=>r.json()).then(x=>{
     if(x.status==="success"){
       alert("üéâ Registered! Code: "+x.code);
       window.location="success.html?code="+x.code+"&pdf="+x.pdfUrl;
     }else alert("‚ùå "+x.message);
   });
 }
});
rz.open();
}*/
</script>

</body>
</html>
